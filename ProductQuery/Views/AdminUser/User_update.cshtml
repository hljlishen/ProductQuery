@model ProductQuery.Models.User
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title></title>
    <link href="~/Content/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/css/templatemo-style.css" rel="stylesheet" />
    <link href="~/Content/css/fontawesome.min.css" rel="stylesheet" />
    <script src="~/Content/js/jquery-3.3.1.min.js"></script>
    <script src="~/Content/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        function validate() {
            var validate = true;

            var name = $("#name").val();
            var phone = $("#phone").val();

            if (name == "") {
                $("#errorname").css("color", "red");
                $("#errorname").attr("class", "glyphicon glyphicon-remove");
                $("#errorname").html("*用户名不能为空");
                validate = false;
            } else {
                $("#errorname").css("color", "green");
                $("#errorname").attr("class", "glyphicon glyphicon-ok");
                $("#errorname").html("");
            }

            if (name != null) {
                var pattern = new RegExp("[`~ !#$^&*()=|{}':;',\\[\\].<>/?~！￥\\\\……&*（）——|{}【】‘；：”“'。，、？]")
                for (var i = 0; i < name.length; i++) {
                    if (pattern.test(name.substr(i, 1))) {
                        $("#errorname").css("color", "red");
                        $("#errorname").attr("class", "glyphicon glyphicon-remove");
                        $("#errorname").html("*用户名存在特殊字符");
                        validate = false;
                    }
                }
            } else {
                $("#errorname").css("color", "green");
                $("#errorname").attr("class", "glyphicon glyphicon-ok");
                $("#errorname").html("");
            }

            if (!(/^1[34578]\d{9}$/.test(phone))) {
                $("#errorphone").css("color", "red");
                $("#errorphone").attr("class", "glyphicon glyphicon-remove");
                $("#errorphone").html("*输入的手机格式错误");
                validate = false;
            } else {
                $("#errorphone").css("color", "green");
                $("#errorphone").attr("class", "glyphicon glyphicon-ok");
                $("#errorphone").html("");
            }

            $.ajax({
                    url: "@Url.Action("User_hasusername","AdminUser")",  
                    type: "post",
                    data: {
                        "oldusername": "@Model.name",
                        "newusername": name
                    },
                    dataType: "json",
                    success: function (data) {
                        data = eval("(" + data + ")");
                        if (data) {
                            $("#errorname2").css("color", "green");
                            $("#errorname2").attr("class", "glyphicon glyphicon-ok");
                            $("#errorname2").html("");
                            if (validate) {
                                update();
                            }
                        } else {
                            $("#errorname2").css("color", "red");
                            $("#errorname2").attr("class", "glyphicon glyphicon-remove");
                            $("#errorname2").html("*该用户名已存在");
                        }
                    }
            });
        }

        function update() {
            $.ajax({
                url: "@Url.Action("User_update")",
                type: "post",
                data: $("form").serialize(),
                dataType: "json",
                success: function (data) {
                    data = eval("(" + data + ")");
                    if (data) {
                        alert("修改成功");
                    } else {
                        alert("修改失败");
                    }
                    parent.closeWin();
                    parent.openFrame("User_list");
                }
            });
        }
    </script>

</head>
<body>
    <div class="row tm-content-row">
        <div class="tm-block-col tm-col-account-settings">
            <div class="tm-bg-primary-dark tm-block tm-block-settings">
                @using (Html.BeginForm(new { @class = "tm-signup-form row", role = "form" }))
                {
                    @Html.HiddenFor(user => user.id)
                    @Html.HiddenFor(user => user.password)
                    <div class="form-group col-lg-6">
                        @Html.LabelFor(user => user.name)
                        @Html.TextBoxFor(user => user.name, new { @class = "form-control validate", id = "name" })
                        <span style="color: red;" id="errorname"></span>
                        <span style="color: red;" id="errorname2"></span>
                    </div>

                    <div class="form-group col-lg-6">
                        @Html.LabelFor(user => user.Phone)
                        @Html.TextBoxFor(user => user.Phone, new { @class = "form-control validate", id = "phone" })
                        <span style="color: red;" id="errorphone"></span>
                    </div>

                    <div class="form-group col-lg-6">
                        @Html.LabelFor(user => user.permissions)
                        @Html.DropDownListFor(model => model.permissions, ViewBag.select as SelectList, new { @class = "custom-select" ,@style = "font-size:13px" })
                    </div>

                    <div class="form-group col-lg-6">
                        <label class="tm-hide-sm">&nbsp;</label>
                        <button type="button" class="btn btn-primary btn-block text-uppercase" onclick="validate();">
                            更新用户信息
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</body>
</html>
